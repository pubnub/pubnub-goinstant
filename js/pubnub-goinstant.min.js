var hasValue=function(e){return!("undefined"==typeof e||null===e)},isFunction=function(e){return!("undefined"==typeof e||null===e||"function"!=typeof e)},isObject=function(e){return!("object"!=typeof e||null===e)};!function(e){if("object"==typeof exports)module.exports=e();else if("function"==typeof define&&define.amd)define(e);else{var n;"undefined"!=typeof window?n=window:"undefined"!=typeof global?n=global:"undefined"!=typeof self&&(n=self),n.stampit=e()}}(function(){var e,n,t;return function r(e,n,t){function o(u,a){if(!n[u]){if(!e[u]){var c="function"==typeof require&&require;if(!a&&c)return c(u,!0);if(i)return i(u,!0);throw new Error("Cannot find module '"+u+"'")}var s=n[u]={exports:{}};e[u][0].call(s.exports,function(n){var t=e[u][1][n];return o(t?t:n)},s,s.exports,r,e,n,t)}return n[u].exports}for(var i="function"==typeof require&&require,u=0;u<t.length;u++)o(t[u]);return o}({1:[function(e,n,t){function r(e,n){this[n]=e}var o=e("mout/object/forIn");n.exports=function i(e,n){for(var t=0,i=arguments.length,u;++t<i;)u=arguments[t],null!=u&&o(u,r,e);return e}},{"mout/object/forIn":14}],2:[function(e,n,t){function r(e,n,t){if(null!=e)for(var r=-1,o=e.length;++r<o&&n.call(t,e[r],r,e)!==!1;);}n.exports=r},{}],3:[function(e,n,t){function r(e,n,t){n=i(n,t);var r=[];if(null==e)return r;for(var o=-1,u=e.length;++o<u;)r[o]=n(e[o],o,e);return r}var o=e("./forEach"),i=e("../function/makeIterator_");n.exports=r},{"../function/makeIterator_":4,"./forEach":2}],4:[function(e,n,t){function r(e,n){switch(typeof e){case"object":return null!=e?function(n,t,r){return i(n,e)}:e;case"string":case"number":return o(e);case"function":return"undefined"==typeof n?e:function(t,r,o){return e.call(n,t,r,o)};default:return e}}var o=e("./prop"),i=e("../object/deepMatches");n.exports=r},{"../object/deepMatches":13,"./prop":5}],5:[function(e,n,t){function r(e){return function(n){return n[e]}}n.exports=r},{}],6:[function(e,n,t){function r(e){switch(c(e)){case"Object":return o(e);case"Array":return a(e);case"RegExp":return i(e);case"Date":return u(e);default:return e}}function o(e){return s(e)?f({},e):e}function i(e){var n="";return n+=e.multiline?"m":"",n+=e.global?"g":"",n+=e.ignorecase?"i":"",new RegExp(e.source,n)}function u(e){return new Date(+e)}function a(e){return e.slice()}var c=e("./kindOf"),s=e("./isPlainObject"),f=e("../object/mixIn");n.exports=r},{"../object/mixIn":18,"./isPlainObject":11,"./kindOf":12}],7:[function(e,n,t){function r(e,n){switch(c(e)){case"Object":return o(e,n);case"Array":return i(e,n);default:return u(e)}}function o(e,n){if(s(e)){var t={};return a(e,function(e,t){this[t]=r(e,n)},t),t}return n?n(e):e}function i(e,n){for(var t=[],o=-1,i=e.length,u;++o<i;)t[o]=r(e[o],n);return t}var u=e("./clone"),a=e("../object/forOwn"),c=e("./kindOf"),s=e("./isPlainObject");n.exports=r},{"../object/forOwn":15,"./clone":6,"./isPlainObject":11,"./kindOf":12}],8:[function(e,n,t){var r=e("./isKind"),o=Array.isArray||function(e){return r(e,"Array")};n.exports=o},{"./isKind":9}],9:[function(e,n,t){function r(e,n){return o(e)===n}var o=e("./kindOf");n.exports=r},{"./kindOf":12}],10:[function(e,n,t){function r(e){return o(e,"Object")}var o=e("./isKind");n.exports=r},{"./isKind":9}],11:[function(e,n,t){function r(e){return!!e&&"object"==typeof e&&e.constructor===Object}n.exports=r},{}],12:[function(e,n,t){function r(e){return null===e?"Null":e===u?"Undefined":o.exec(i.call(e))[1]}var o=/^\[object (.*)\]$/,i=Object.prototype.toString,u;n.exports=r},{}],13:[function(e,n,t){function r(e,n){for(var t=-1,r=e.length;++t<r;)if(u(e[t],n))return!0;return!1}function o(e,n){for(var t=-1,o=n.length;++t<o;)if(!r(e,n[t]))return!1;return!0}function i(e,n){var t=!0;return a(n,function(n,r){return u(e[r],n)?void 0:t=!1}),t}function u(e,n){return e&&"object"==typeof e?c(e)&&c(n)?o(e,n):i(e,n):e===n}var a=e("./forOwn"),c=e("../lang/isArray");n.exports=u},{"../lang/isArray":8,"./forOwn":15}],14:[function(e,n,t){function r(){a=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],u=!0;for(var e in{toString:null})u=!1}function o(e,n,t){var o,c=0;null==u&&r();for(o in e)if(i(n,e,o,t)===!1)break;if(u)for(;(o=a[c++])&&(e[o]===Object.prototype[o]||i(n,e,o,t)!==!1););}function i(e,n,t,r){return e.call(r,n[t],t,n)}var u,a;n.exports=o},{}],15:[function(e,n,t){function r(e,n,t){i(e,function(r,i){return o(e,i)?n.call(t,e[i],i,e):void 0})}var o=e("./hasOwn"),i=e("./forIn");n.exports=r},{"./forIn":14,"./hasOwn":16}],16:[function(e,n,t){function r(e,n){return Object.prototype.hasOwnProperty.call(e,n)}n.exports=r},{}],17:[function(e,n,t){function r(){var e=1,n,t,a,c;for(c=i(arguments[0]);a=arguments[e++];)for(n in a)o(a,n)&&(t=a[n],c[n]=u(t)&&u(c[n])?r(c[n],t):i(t));return c}var o=e("./hasOwn"),i=e("../lang/deepClone"),u=e("../lang/isObject");n.exports=r},{"../lang/deepClone":7,"../lang/isObject":10,"./hasOwn":16}],18:[function(e,n,t){function r(e,n){for(var t=0,r=arguments.length,u;++t<r;)u=arguments[t],null!=u&&i(u,o,e);return e}function o(e,n){this[n]=e}var i=e("./forOwn");n.exports=r},{"./forOwn":15}],19:[function(e,n,t){"use strict";var r=e("mout/array/forEach"),o=e("mout/object/mixIn"),i=e("mout/object/merge"),u=e("mout/array/map"),a=e("mout/object/forOwn"),c=e("./mixinchain.js"),s=[].slice,f=function(e){function n(){}if(arguments.length>1)throw new Error("Object.create implementation only accepts the first parameter.");return n.prototype=e,new n};Array.isArray||(Array.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)});var l=function m(e){var n=[],t=[].slice.call(arguments);return"function"==typeof e?n=u(t,function(e){return"function"==typeof e?e:void 0}):"object"==typeof e?r(t,function(e){a(e,function(e){n.push(e)})}):Array.isArray(e)&&r(e,function(e){n.push(e)}),n},p=function y(e,n,t){var u={methods:e||{},state:n,enclose:l(t)},a=function p(e){var n=i({},u.state),t=o(f(u.methods||{}),n,e),a=u.enclose,c=s.call(arguments,1);return r(a,function(e){"function"==typeof e&&(t=e.apply(t,c)||t)}),t};return o(a,{create:a,fixed:u,methods:function d(){var e=u.methods||{},n=[e].concat([].slice.call(arguments));return u.methods=c.apply(this,n),this},state:function h(){var e=u.state||{},n=[e].concat([].slice.call(arguments));return u.state=o.apply(this,n),this},enclose:function m(){return u.enclose=u.enclose.concat(l.apply(null,arguments)),this}})},d=function v(){var e=[].slice.call(arguments),n=p();return r(e,function(e){e&&(e.fixed.methods&&(n.fixed.methods=c({},n.fixed.methods,e.fixed.methods)),e.fixed.state&&(n.fixed.state=o({},n.fixed.state,e.fixed.state)),e.fixed.enclose&&(n.fixed.enclose=n.fixed.enclose.concat(e.fixed.enclose)))}),p(n.fixed.methods,n.fixed.state,n.fixed.enclose)},h=function g(e){return p().methods(e.prototype).enclose(e)};n.exports=o(p,{compose:d,extend:o,mixIn:o,convertConstructor:h})},{"./mixinchain.js":1,"mout/array/forEach":2,"mout/array/map":3,"mout/object/forOwn":15,"mout/object/merge":17,"mout/object/mixIn":18}]},{},[19])(19)}),function(e){if("function"==typeof bootstrap)bootstrap("promise",e);else if("object"==typeof exports)module.exports=e();else if("function"==typeof define&&define.amd)define(e);else if("undefined"!=typeof ses){if(!ses.ok())return;ses.makeQ=e}else Q=e()}(function(){"use strict";function e(e){return function(){return q.apply(e,arguments)}}function n(e){return e===Object(e)}function t(e){return"[object StopIteration]"===nn(e)||e instanceof tn}function r(e,n){if(A&&n.stack&&"object"==typeof e&&null!==e&&e.stack&&-1===e.stack.indexOf(rn)){for(var t=[],r=n;r;r=r.source)r.stack&&t.unshift(r.stack);t.unshift(e.stack);var i=t.join("\n"+rn+"\n");e.stack=o(i)}}function o(e){for(var n=e.split("\n"),t=[],r=0;r<n.length;++r){var o=n[r];a(o)||i(o)||!o||t.push(o)}return t.join("\n")}function i(e){return-1!==e.indexOf("(module.js:")||-1!==e.indexOf("(node.js:")}function u(e){var n=/at .+ \((.+):(\d+):(?:\d+)\)$/.exec(e);if(n)return[n[1],Number(n[2])];var t=/at ([^ ]+):(\d+):(?:\d+)$/.exec(e);if(t)return[t[1],Number(t[2])];var r=/.*@(.+):(\d+)$/.exec(e);return r?[r[1],Number(r[2])]:void 0}function a(e){var n=u(e);if(!n)return!1;var t=n[0],r=n[1];return t===Q&&r>=T&&cn>=r}function c(){if(A)try{throw new Error}catch(e){var n=e.stack.split("\n"),t=n[0].indexOf("@")>0?n[1]:n[2],r=u(t);if(!r)return;return Q=r[0],r[1]}}function s(e,n,t){return function(){return"undefined"!=typeof console&&"function"==typeof console.warn&&console.warn(n+" is deprecated, use "+t+" instead.",new Error("").stack),e.apply(e,arguments)}}function f(e){return v(e)?e:g(e)?G(e):E(e)}function l(){function e(e){r=e,i.source=e,J(n,function(n,t){M(function(){e.promiseDispatch.apply(e,t)})},void 0),n=void 0,t=void 0}var n=[],t=[],r,o=X(l.prototype),i=X(h.prototype);if(i.promiseDispatch=function(e,o,i){var u=Y(arguments);n?(n.push(u),"when"===o&&i[1]&&t.push(i[1])):M(function(){r.promiseDispatch.apply(r,u)})},i.valueOf=function(){if(n)return i;var e=y(r);return v(e)&&(r=e),e},i.inspect=function(){return r?r.inspect():{state:"pending"}},f.longStackSupport&&A)try{throw new Error}catch(u){i.stack=u.stack.substring(u.stack.indexOf("\n")+1)}return o.promise=i,o.resolve=function(n){r||e(f(n))},o.fulfill=function(n){r||e(E(n))},o.reject=function(n){r||e(R(n))},o.notify=function(e){r||J(t,function(n,t){M(function(){t(e)})},void 0)},o}function p(e){if("function"!=typeof e)throw new TypeError("resolver must be a function.");var n=l();try{e(n.resolve,n.reject,n.notify)}catch(t){n.reject(t)}return n.promise}function d(e){return p(function(n,t){for(var r=0,o=e.length;o>r;r++)f(e[r]).then(n,t)})}function h(e,n,t){void 0===n&&(n=function(e){return R(new Error("Promise does not support operation: "+e))}),void 0===t&&(t=function(){return{state:"unknown"}});var r=X(h.prototype);if(r.promiseDispatch=function(t,o,i){var u;try{u=e[o]?e[o].apply(r,i):n.call(r,o,i)}catch(a){u=R(a)}t&&t(u)},r.inspect=t,t){var o=t();"rejected"===o.state&&(r.exception=o.reason),r.valueOf=function(){var e=t();return"pending"===e.state||"rejected"===e.state?r:e.value}}return r}function m(e,n,t,r){return f(e).then(n,t,r)}function y(e){if(v(e)){var n=e.inspect();if("fulfilled"===n.state)return n.value}return e}function v(e){return n(e)&&"function"==typeof e.promiseDispatch&&"function"==typeof e.inspect}function g(e){return n(e)&&"function"==typeof e.then}function b(e){return v(e)&&"pending"===e.inspect().state}function O(e){return!v(e)||"fulfilled"===e.inspect().state}function j(e){return v(e)&&"rejected"===e.inspect().state}function k(){on.length=0,un.length=0,an||(an=!0)}function x(e,n){an&&(un.push(e),on.push(n&&"undefined"!=typeof n.stack?n.stack:"(no stack) "+n))}function w(e){if(an){var n=H(un,e);-1!==n&&(un.splice(n,1),on.splice(n,1))}}function R(e){var n=h({when:function(n){return n&&w(this),n?n(e):this}},function t(){return this},function r(){return{state:"rejected",reason:e}});return x(n,e),n}function E(e){return h({when:function(){return e},get:function(n){return e[n]},set:function(n,t){e[n]=t},"delete":function(n){delete e[n]},post:function(n,t){return null===n||void 0===n?e.apply(void 0,t):e[n].apply(e,t)},apply:function(n,t){return e.apply(n,t)},keys:function(){return en(e)}},void 0,function n(){return{state:"fulfilled",value:e}})}function G(e){var n=l();return M(function(){try{e.then(n.resolve,n.reject,n.notify)}catch(t){n.reject(t)}}),n.promise}function D(e){return h({isDef:function(){}},function n(t,r){return L(e,t,r)},function(){return f(e).inspect()})}function B(e,n,t){return f(e).spread(n,t)}function U(e){return function(){function n(e,n){var u;if("undefined"==typeof StopIteration){try{u=r[e](n)}catch(a){return R(a)}return u.done?u.value:m(u.value,o,i)}try{u=r[e](n)}catch(a){return t(a)?a.value:R(a)}return m(u,o,i)}var r=e.apply(this,arguments),o=n.bind(n,"next"),i=n.bind(n,"throw");return o()}}function K(e){f.done(f.async(e)())}function _(e){throw new tn(e)}function V(e){return function(){return B([this,C(arguments)],function(n,t){return e.apply(n,t)})}}function L(e,n,t){return f(e).dispatch(n,t)}function C(e){return m(e,function(e){var n=0,t=l();return J(e,function(r,o,i){var u;v(o)&&"fulfilled"===(u=o.inspect()).state?e[i]=u.value:(++n,m(o,function(r){e[i]=r,0===--n&&t.resolve(e)},t.reject,function(e){t.notify({index:i,value:e})}))},void 0),0===n&&t.resolve(e),t.promise})}function N(e){return m(e,function(e){return e=W(e,f),m(C(W(e,function(e){return m(e,z,z)})),function(){return e})})}function P(e){return f(e).allSettled()}function I(e,n){return f(e).then(void 0,void 0,n)}function S(e,n){return f(e).nodeify(n)}var A=!1;try{throw new Error}catch(F){A=!!F.stack}var T=c(),Q,z=function(){},M=function(){function e(){for(;n.next;){n=n.next;var t=n.task;n.task=void 0;var o=n.domain;o&&(n.domain=void 0,o.enter());try{t()}catch(u){if(i)throw o&&o.exit(),setTimeout(e,0),o&&o.enter(),u;setTimeout(function(){throw u},0)}o&&o.exit()}r=!1}var n={task:void 0,next:null},t=n,r=!1,o=void 0,i=!1;if(M=function(e){t=t.next={task:e,domain:i&&process.domain,next:null},r||(r=!0,o())},"undefined"!=typeof process&&process.nextTick)i=!0,o=function(){process.nextTick(e)};else if("function"==typeof setImmediate)o="undefined"!=typeof window?setImmediate.bind(window,e):function(){setImmediate(e)};else if("undefined"!=typeof MessageChannel){var u=new MessageChannel;u.port1.onmessage=function(){o=a,u.port1.onmessage=e,e()};var a=function(){u.port2.postMessage(0)};o=function(){setTimeout(e,0),a()}}else o=function(){setTimeout(e,0)};return M}(),q=Function.call,Y=e(Array.prototype.slice),J=e(Array.prototype.reduce||function(e,n){var t=0,r=this.length;if(1===arguments.length)for(;;){if(t in this){n=this[t++];break}if(++t>=r)throw new TypeError}for(;r>t;t++)t in this&&(n=e(n,this[t],t));return n}),H=e(Array.prototype.indexOf||function(e){for(var n=0;n<this.length;n++)if(this[n]===e)return n;return-1}),W=e(Array.prototype.map||function(e,n){var t=this,r=[];return J(t,function(o,i,u){r.push(e.call(n,i,u,t))},void 0),r}),X=Object.create||function(e){function n(){}return n.prototype=e,new n},Z=e(Object.prototype.hasOwnProperty),en=Object.keys||function(e){var n=[];for(var t in e)Z(e,t)&&n.push(t);return n},nn=e(Object.prototype.toString),tn;tn="undefined"!=typeof ReturnValue?ReturnValue:function(e){this.value=e};var rn="From previous event:";f.resolve=f,f.nextTick=M,f.longStackSupport=!1,f.defer=l,l.prototype.makeNodeResolver=function(){var e=this;return function(n,t){n?e.reject(n):e.resolve(arguments.length>2?Y(arguments,1):t)}},f.Promise=p,f.promise=p,p.race=d,p.all=C,p.reject=R,p.resolve=f,f.passByCopy=function(e){return e},h.prototype.passByCopy=function(){return this},f.join=function(e,n){return f(e).join(n)},h.prototype.join=function(e){return f([this,e]).spread(function(e,n){if(e===n)return e;throw new Error("Can't join: not the same: "+e+" "+n)})},f.race=d,h.prototype.race=function(){return this.then(f.race)},f.makePromise=h,h.prototype.toString=function(){return"[object Promise]"},h.prototype.then=function(e,n,t){function o(n){try{return"function"==typeof e?e(n):n}catch(t){return R(t)}}function i(e){if("function"==typeof n){r(e,a);try{return n(e)}catch(t){return R(t)}}return R(e)}function u(e){return"function"==typeof t?t(e):e}var a=this,c=l(),s=!1;return M(function(){a.promiseDispatch(function(e){s||(s=!0,c.resolve(o(e)))},"when",[function(e){s||(s=!0,c.resolve(i(e)))}])}),a.promiseDispatch(void 0,"when",[void 0,function(e){var n,t=!1;try{n=u(e)}catch(r){if(t=!0,!f.onerror)throw r;f.onerror(r)}t||c.notify(n)}]),c.promise},f.when=m,h.prototype.thenResolve=function(e){return this.then(function(){return e})},f.thenResolve=function(e,n){return f(e).thenResolve(n)},h.prototype.thenReject=function(e){return this.then(function(){throw e})},f.thenReject=function(e,n){return f(e).thenReject(n)},f.nearer=y,f.isPromise=v,f.isPromiseAlike=g,f.isPending=b,h.prototype.isPending=function(){return"pending"===this.inspect().state},f.isFulfilled=O,h.prototype.isFulfilled=function(){return"fulfilled"===this.inspect().state},f.isRejected=j,h.prototype.isRejected=function(){return"rejected"===this.inspect().state};var on=[],un=[],an=!0;f.resetUnhandledRejections=k,f.getUnhandledReasons=function(){return on.slice()},f.stopUnhandledRejectionTracking=function(){k(),an=!1},k(),f.reject=R,f.fulfill=E,f.master=D,f.spread=B,h.prototype.spread=function(e,n){return this.all().then(function(n){return e.apply(void 0,n)},n)},f.async=U,f.spawn=K,f["return"]=_,f.promised=V,f.dispatch=L,h.prototype.dispatch=function(e,n){var t=this,r=l();return M(function(){t.promiseDispatch(r.resolve,e,n)}),r.promise},f.get=function(e,n){return f(e).dispatch("get",[n])},h.prototype.get=function(e){return this.dispatch("get",[e])},f.set=function(e,n,t){return f(e).dispatch("set",[n,t])},h.prototype.set=function(e,n){return this.dispatch("set",[e,n])},f.del=f["delete"]=function(e,n){return f(e).dispatch("delete",[n])},h.prototype.del=h.prototype["delete"]=function(e){return this.dispatch("delete",[e])},f.mapply=f.post=function(e,n,t){return f(e).dispatch("post",[n,t])},h.prototype.mapply=h.prototype.post=function(e,n){return this.dispatch("post",[e,n])},f.send=f.mcall=f.invoke=function(e,n){return f(e).dispatch("post",[n,Y(arguments,2)])},h.prototype.send=h.prototype.mcall=h.prototype.invoke=function(e){return this.dispatch("post",[e,Y(arguments,1)])},f.fapply=function(e,n){return f(e).dispatch("apply",[void 0,n])},h.prototype.fapply=function(e){return this.dispatch("apply",[void 0,e])},f["try"]=f.fcall=function(e){return f(e).dispatch("apply",[void 0,Y(arguments,1)])},h.prototype.fcall=function(){return this.dispatch("apply",[void 0,Y(arguments)])},f.fbind=function(e){var n=f(e),t=Y(arguments,1);return function r(){return n.dispatch("apply",[this,t.concat(Y(arguments))])}},h.prototype.fbind=function(){var e=this,n=Y(arguments);return function t(){return e.dispatch("apply",[this,n.concat(Y(arguments))])}},f.keys=function(e){return f(e).dispatch("keys",[])},h.prototype.keys=function(){return this.dispatch("keys",[])},f.all=C,h.prototype.all=function(){return C(this)},f.allResolved=s(N,"allResolved","allSettled"),h.prototype.allResolved=function(){return N(this)},f.allSettled=P,h.prototype.allSettled=function(){return this.then(function(e){return C(W(e,function(e){function n(){return e.inspect()}return e=f(e),e.then(n,n)}))})},f.fail=f["catch"]=function(e,n){return f(e).then(void 0,n)},h.prototype.fail=h.prototype["catch"]=function(e){return this.then(void 0,e)},f.progress=I,h.prototype.progress=function(e){return this.then(void 0,void 0,e)},f.fin=f["finally"]=function(e,n){return f(e)["finally"](n)},h.prototype.fin=h.prototype["finally"]=function(e){return e=f(e),this.then(function(n){return e.fcall().then(function(){return n})},function(n){return e.fcall().then(function(){throw n})})},f.done=function(e,n,t,r){return f(e).done(n,t,r)},h.prototype.done=function(e,n,t){var o=function(e){M(function(){if(r(e,i),!f.onerror)throw e;f.onerror(e)})},i=e||n||t?this.then(e,n,t):this;"object"==typeof process&&process&&process.domain&&(o=process.domain.bind(o)),i.then(void 0,o)},f.timeout=function(e,n,t){return f(e).timeout(n,t)},h.prototype.timeout=function(e,n){var t=l(),r=setTimeout(function(){t.reject(new Error(n||"Timed out after "+e+" ms"))},e);return this.then(function(e){clearTimeout(r),t.resolve(e)},function(e){clearTimeout(r),t.reject(e)},t.notify),t.promise},f.delay=function(e,n){return void 0===n&&(n=e,e=void 0),f(e).delay(n)},h.prototype.delay=function(e){return this.then(function(n){var t=l();return setTimeout(function(){t.resolve(n)},e),t.promise})},f.nfapply=function(e,n){return f(e).nfapply(n)},h.prototype.nfapply=function(e){var n=l(),t=Y(e);return t.push(n.makeNodeResolver()),this.fapply(t).fail(n.reject),n.promise},f.nfcall=function(e){var n=Y(arguments,1);return f(e).nfapply(n)},h.prototype.nfcall=function(){var e=Y(arguments),n=l();return e.push(n.makeNodeResolver()),this.fapply(e).fail(n.reject),n.promise},f.nfbind=f.denodeify=function(e){var n=Y(arguments,1);return function(){var t=n.concat(Y(arguments)),r=l();return t.push(r.makeNodeResolver()),f(e).fapply(t).fail(r.reject),r.promise}},h.prototype.nfbind=h.prototype.denodeify=function(){var e=Y(arguments);return e.unshift(this),f.denodeify.apply(void 0,e)},f.nbind=function(e,n){var t=Y(arguments,2);return function(){function r(){return e.apply(n,arguments)}var o=t.concat(Y(arguments)),i=l();return o.push(i.makeNodeResolver()),f(r).fapply(o).fail(i.reject),i.promise}},h.prototype.nbind=function(){var e=Y(arguments,0);return e.unshift(this),f.nbind.apply(void 0,e)},f.nmapply=f.npost=function(e,n,t){return f(e).npost(n,t)},h.prototype.nmapply=h.prototype.npost=function(e,n){var t=Y(n||[]),r=l();return t.push(r.makeNodeResolver()),this.dispatch("post",[e,t]).fail(r.reject),r.promise},f.nsend=f.nmcall=f.ninvoke=function(e,n){var t=Y(arguments,2),r=l();return t.push(r.makeNodeResolver()),f(e).dispatch("post",[n,t]).fail(r.reject),r.promise},h.prototype.nsend=h.prototype.nmcall=h.prototype.ninvoke=function(e){var n=Y(arguments,1),t=l();return n.push(t.makeNodeResolver()),this.dispatch("post",[e,n]).fail(t.reject),t.promise},f.nodeify=S,h.prototype.nodeify=function(e){return e?void this.then(function(n){M(function(){e(null,n)})},function(n){M(function(){e(n)})}):this};var cn=c();return f}),window.goinstant2={},window.goinstant2.BaseClasses={},goinstant2.BaseClasses.logger=stampit().enclose(function(){var e=!1,n=!1;return stampit.mixIn(this,{debug:function(n,t,r,o,i,u){if(e){var a="";_.times(n,function(e){a+="	"}),a+=t,a+="::"+r+"()",a+=" ("+o+") ",a+=i,u&&hasValue(u)?console.debug(a,u):console.debug(a)}},log:function(n,t,r,o,i){if(e){var u="";_.times(n,function(e){u+="	"}),u+=t,u+="::"+r+"() ",hasValue(o)&&isObject(i)?console.log(u+o.toString(),i):isObject(o)&&hasValue(o)?console.log(u,o):console.log(hasValue(o)?u+" "+o.toString():u)}},info:function(t,r,o){if(e&&n){var i="";i+=hasValue(r)?r+": ":"",i+=hasValue(o)?o+"() - ":"",isObject(t)?console.info(i,"%O",t):(i+=t,console.info(i))}},error:function(n,t,r){if(e){var o="";o+=hasValue(n)?n+"::":"",o+=hasValue(t)?t+"() ":"",console.error(o,r)}},useLogging:function(n){return n?(e=n,this):e}})}),goinstant2.App=new goinstant2.BaseClasses.logger,goinstant2.App.useLogging(!0),LOG=goinstant2.App.log,INFO=goinstant2.App.info,ERROR=goinstant2.App.error,DEBUG=goinstant2.App.debug,LOG_GROUP=function(e){goinstant2.App.useLogging()&&console.group(e)},LOG_GROUP_END=function(){goinstant2.App.useLogging()&&console.groupEnd()},goinstant2.Connection=function(e){return(new goinstant2.BaseClasses.connection).url(e)},goinstant2.connect=function(e,n,t){return new goinstant2.Connection(e).connect(n,t)},goinstant2.BaseClasses.connection=stampit().enclose(function(){function e(){var e=u.slice(15).split("/");f.keys={publish_key:e[0],subscribe_key:e[1],secret_key:e[2],origin:"pubsub-beta.pubnub.com"},i=PUBNUB.init({})}function n(e){r=hasValue(e)?e:{},hasValue(r.displayName)||(r.displayName="Guest "+Math.floor(1e5*Math.random()+1e4).toString()),hasValue(r.id)||hasValue(r.token)?hasValue(r.token)&&(r.id=i.uuid()):r.id=i.uuid(),f.user=r,f.keys.state=r}function t(){i=PUBNUB.init(f.keys),f.pubnub=i}var r=null,o=!1,i=null,u,a,c,s,f={connection:this,user:null,rooms:[],pubnub:null,keys:{}};return stampit.mixIn(this,{url:function(n){return n?(u=n,e(),this):u},context:function(){return f},connect:function(e,o){var i=!1,u=!1,a=!1,c,s,l,p=[];hasValue(e)&&hasValue(o)?(i=!0,u=!0,c=e,s=o):isFunction(e)?(u=!0,s=e):isObject(e)?(i=!0,a=!0,c=e,DEBUG(0,"Connection","connect","","promise created"),l=Q.defer()):(a=!0,DEBUG(0,"Connection","connect","","promise created"),l=Q.defer()),i&&(LOG(c,"Connection","connect - hasOptions"),_.has(c,"user")&&hasValue(c.user)?n(c.user):n(),_.has(c,"room")?p.push(c.room):_.has(c,"rooms")&&_.forEach(c.rooms,function(e){p.push(e)}),_.has(c,"visible")&&c.visible&&console.warn("#goinstant2.connect option 'visible: false' not available in this SDK")),t(),0==p.length&&p.push("lobby"),DEBUG(0,"Connection","connect","","connecting rooms",p);var d=_.map(p,function(e){var n=new goinstant2.BaseClasses.room;return n.context(f).name(e),hasValue(r)&&n.setUser(r),n.join()});if(a){var h={connection:this,rooms:[],context:f};return Q.allSettled(d).then(function(e){INFO("check for errors on room joins","Connection","TODO - connect"),_.forEach(e,function(e){f.rooms.push(e.value.room)}),h.rooms=f.rooms,DEBUG(0,"Connection","connect","","complete - promise",e),l.resolve(h)}),l.promise}var m=null,y=[m];return y.push(this),INFO("Connection Errors are only generated from Room objects","Connection","connect"),Q.allSettled(d).then(function(e){INFO("check for errors on room joins","Connection","TODO - connect"),_.forEach(p,function(e){y.push(e)}),DEBUG(0,"Connection","connect","","complete - callback"),s.apply(this,y)}),this},room:function(e){_.forEach(f.rooms,function(n){return n.name===e?(DEBUG(0,"Connection","room",e,"room already joined"),n):void 0}),DEBUG(0,"Connection","room",e,"join room");var n=new goinstant2.BaseClasses.room;n.context(f).name(e),hasValue(r)&&n.setUser(r);var t=n.join();return t.then(function(e){f.rooms.push(n)}),t},rooms:function(){return f.rooms},isGuest:function(){return o},user:function(){return r}})}),goinstant2.BaseClasses.room=stampit().enclose(function(){function e(e){DEBUG(1,"Room","_presence["+i+"]","","",e),"join"===e.action?"function"==typeof s.join&&s.join({user:e.uuid}):("leave"===e.action||"timeout"===e.action)&&"function"==typeof s.leave&&s.leave({user:e.uuid})}function n(e,n,t){}var t,r,o,i,u,a,c,s={join:null,leave:null,joinLocal:null,leaveLocal:null},f=!1;return stampit.mixIn(this,{name:function(e){return e?(o=e,i="ROOM:::"+e,this):o},context:function(e){return e?(t=e,r=t.pubnub,this):t},joined:function(){return f},self:function(){return INFO("return data sync info (KEY) for user with userID","Room","TODO - user"),a},setUser:function(e){u=e},user:function(e){return LOG(e,"Room","user"),INFO("return data sync info (KEY) for user with userID","Room","TODO - user"),u&&hasValue(u.id)&&e===u.id?a:_key("'.users'."+_userID)},users:function(e){LOG("users collection","Room","users");var n=new goinstant2.BaseClasses.key,r="'.users'";return n.room(this).context(t).syncObject(c).path(r),n.startSync().then(function(){LOG("sync ready","Room","users"),n.info(),e&&n.remove().then(function(){n.info()})}),n},key:function(e){var n=new goinstant2.BaseClasses.key;return n.room(this).context(t).syncObject(c).path(e),DEBUG(1,"Room","key",e,"sync object initialize"),n.sync(function(){DEBUG(1,"Room","key",n.fullPath(),"sync object ready")}),n},join:function(s,l,p){var d=this,h=!1,m=!1,y=!1,v=!1,g,b,O;hasValue(s)&&hasValue(l)&&hasValue(p)?(h=!0,m=!0,y=!0,u=s,b=l,O=p):hasValue(s)&&hasValue(l)?(h=!0,y=!0,u=s,O=l):hasValue(s)?(y=!0,O=s):(v=!0,g=Q.defer(),DEBUG(1,"Room","join",i,"promise created")),t.room=o,DEBUG(1,"Room","join",o,"start join process"),!h&&hasValue(u)?h=!0:(u={},h=!0),hasValue(u.displayName)||(u.displayName="Guest "+Math.floor(1e5*Math.random()+1e4).toString()),hasValue(u.id)||(u.id=r.uuid()),c=i,DEBUG(1,"Room","join",i,"create this user sync object",{object_id:".'.users'/"+u.id,user:u}),a=new goinstant2.BaseClasses.key;var j="'.users'."+u.id;return a.room(this).context(t).syncObject(c).path(j).initializeData({action:"merge",value:u}),DEBUG(1,"Room","join",i,"sync initiate"),a.sync(function(){DEBUG(1,"Room","join",o,"sync complete");var t={channel:i,presence:function(n){e(n)},message:function(e,t,r){n(e,t,r)},connect:function(){LOG("PUBNUB connected to "+i,"Room","join._pubnub.subscribe.connect"),f=!0},disconnect:function(){LOG("PUBNUB disconnected "+i,"Room","join._pubnub.subscribe.disconnect"),f=!1,console.log(_state)}};return t.state=u,v?(t.connect=function(){f=!0;var e={err:null,room:d,user:u};DEBUG(1,"Room","join",i,"promise resolved"),g.resolve(e)},t.error=function(e){ERROR("promise rejected","Room","join"),g.reject(new Error(e))},DEBUG(1,"Room","join",i,"PUBNUB subscribe for presence"),r.subscribe(t),g.promise):(LOG("callback pending","Room","join"),INFO("callback","Room","TODO - join"),this)}),v?g.promise:void 0},leave:function(e){return LOG("PUBNUB unsubscribe to "+o,"Room","leave"),r.unsubscribe({channel:i}),isFunction(e)&&e({err:null}),this},on:function(e,n,t){LOG(e,"Room","on");var r=!1,o=!1,i=null,u=null;"undefined"!=typeof n&&"undefined"!=typeof t?(r=!0,o=!0,i=n,u=t):"object"==typeof n?(r=!0,i=n):"function"==typeof n&&(o=!0,u=n),"join"===e?s.join=u:"leave"===e&&(s.leave=u)},off:function(e,n,t){LOG(e,"Room","off");var r=!1,o=!1,i=!1,u=null,a=null;("undefined"!=typeof e||null!=e)&&(r=!0),"undefined"!=typeof n&&"undefined"!=typeof t?(o=!0,i=!0,u=n,a=t):"object"==typeof n?(o=!0,u=n):"function"==typeof n&&(i=!0,a=n),r||o||i||(s.join=null,s.leave=null)}})}),goinstant2.Channel=function e(n,t){function r(e,n,t){isFunction(s.message)&&message(e)}function o(e,n){var t={err:null},r=function o(e){null!==e&&"undefined"!=typeof e&&(t.err=e)};u.publish({channel:a,message:e,error:r}),isFunction(n)&&n(t)}var i=n,u=i.pubnub,a=t,c={joined:!1},s={message:null};return function f(){var e={channel:a,message:function(e,n,t){r(e,n,t)},connect:function(){this._state.joined=!0},disconnect:function(){this._state.joined=!1}};"undefined"!==_user.displayName&&(e.state={id:_user.id,displayName:_user.displayName}),u.subscribe(e)}(),{message:function(e,n){o(e,n)},on:function(e,n){hasValue(e)&&"message"===e&&isFunction(n)&&(s.message=n)}}},goinstant2.BaseClasses.key=stampit().enclose(function(){function e(e){var n=_.map(h,function(e){return"set"===e.action?t.set(e.value,{initializeOverride:!0}):"merge"===e.action?t.merge(e.value,{initializeOverride:!0}):"add"===e.action?t.add(e.value,{initializeOverride:!0}):"remove"===e.action?t.remove({initializeOverride:!0}):void 0});Q.allSettled(n).then(function(){DEBUG(2,"Key","_initialize",u,"initializeData complete"),h=[],l=!0,e()})}function n(e){var n=_.map(m,function(e){return"get"===e.action?e.usePromise?(LOG("execute get() - promise","Room","startSync - deferredOperations"),self.get(function(n,t,r){var o={err:n,value:t,context:r};console.log(o),e.defer.resolve(o)}),e.defer):self.get().then(function(n){var t=[null,value,r];e.callback.apply(this,t)}):"set"===e.action?(LOG("execute set()","Room","startSync - deferredOperations"),self.set(e.value).then(e.usePromise?function(n){e.defer.resolve(n)}:function(n){var t=[null,value,r];e.callback.apply(this,t)})):"add"===e.action?(LOG("execute add()","Room","startSync - deferredOperations"),self.add(e.value).then(e.usePromise?function(n){e.defer.resolve(n)}:function(n){var t=[null,value,r];e.callback.apply(this,t)})):"merge"===e.action?(LOG("execute merge()","Room","startSync - deferredOperations"),self.merge(e.value).then(e.usePromise?function(n){e.defer.resolve(n)}:function(n){var t=[null,value,r];e.callback.apply(this,t)})):"remove"===e.action?(LOG("execute remove()","Room","startSync - deferredOperations"),self.remove().then(e.usePromise?function(n){e.defer.resolve(n)}:function(n){var t=[null,value,r];e.callback.apply(this,t)})):void 0});Q.allSettled(n).then(function(){DEBUG(2,"Key","_deferred",c,"deferred complete"),m=[],p=!0,e()}).catch(function(e){ERROR("KEY","_initializeData",e)})}var t,r,o,i,u,a,c,s,s,f=!1,l=!1,p=!1,d=[],h=[],m=[],y=[],v={set:[],add:[],remove:[],setLocal:[],addLocal:[],removeLocal:[]};return stampit.mixIn(this,{context:function(e){return t=this,e?(r=e,o=r.pubnub,this):r},room:function(e){return e?(i=e,this):i},key:function(e){var n=new goinstant2.BaseClasses.key;return n.room(this).context(r).roomName(_roomName).name(e).parent(this),n},parent:function(){return value?(_parent=value,this):_parent},fullPath:function(){return c},info:function(){LOG_GROUP("Key: INFO()"),LOG(u,"Key","key.objectID"),LOG(a,"Key","key.path"),LOG(s.get(),"Key","key.value"),LOG_GROUP_END()},syncObject:function(e){return e?(u=e,c=u+"."+a,this):u},path:function(e,n){return e?(a=e.replace(/\//g,"."),c=u+"."+a,this):a},isSynced:function(){return p},initializeData:function(e){return!f&&e?(h.push(e),this):h},sync:function(t){DEBUG(2,"Key","sync",c,"sync initiate"),s=o.sync(c),s.on.ready(function(){var r=s.get();
DEBUG(2,"Key","sync",c,"sync ready"),DEBUG(2,"Key","sync",c,"initializeData start"),e(function(){DEBUG(2,"Key","sync",c,"initializeData complete"),p=!0,n(function(){DEBUG(2,"Key","sync",c,"deferred complete"),DEBUG(2,"Key","sync",c,"execute callbacks",d),_.forEach(d,function(e){DEBUG(2,"Key","sync",c,"execute callbacks",{type:e.operation+"()"}),e.callback.apply(this,e.params)}),t()})})}),s.on.update(function(e){DEBUG(2,"Key","sync.on.update",c,"received",e);var n,t;_.forEach(e.location,function(e){t=e.replace(c,"").split(".");var r=t.pop();t=t.pop(),n=s.get()[t]}),DEBUG(2,"Key","sync.on.update",c,"value",n),DEBUG(2,"Key","sync.on.update",c,"context",r),_.forEach(v.add,function(e){e(n,n.context)})}),s.on.set(function(e){DEBUG(2,"Key","sync.on.set",c,"received",e),_.forEach(v.set,function(e){})})},get:function(e){DEBUG(2,"Key","get",c,"");var n=this,t=!1,o=!1,i,u;hasValue(e)?(t=!0,i=e):(o=!0,u=Q.defer());var a=function(e,t){var o=!1,i=!1,u,a;if(hasValue(t)&&t?(o=!0,a=e):hasValue(e)&&isFunction(e)?(i=!0,u=e):(o=!0,a=Q.defer()),o){var c={err:null,value:s.get(),context:r};return LOG(2,"Key","get","get successful - promise",c),a.resolve(c),a.promise}LOG(2,"Key","get","get successful - callback");var f=[null,s.get(),r];return u.apply(this,f),n};if(!p){var f=t?[e]:[u,o],l={operation:"get",callback:a,params:f,self:n};return d.push(l),LOG(2,"Key","get","not ready for get() operations",l),o?u.promise:n}return a(e)},add:function(e,n,t){DEBUG(2,"Key","add",c,"");var i=this,f=!1,l=!1,h=!1,m=!1,y,v,g;hasValue(n)&&hasValue(t)?(f=!0,l=!0,y=n,v=t):hasValue(n)?isFunction(n)?(l=!0,v=n):(f=!0,h=!0,y=n,g=Q.defer()):(h=!0,g=Q.defer());var b=function(n,t,f,l,p){var d=!1,h=!1,m=!1,t,y,v;if(hasValue(p)&&p?(d=!0,v=f):(h=!0,t=t),hasValue(l)&&(m=!0,y=l),d){var g=a+".";o.time(function(n){g+=n;var i={addedKey:"/"+a+"/"+g,currentKey:"/"+a,targetKey:"/"+a,userId:r.user.id,command:"ADD",value:JSON.parse(JSON.stringify(e)),room:r.room};e.context=i;var s={object_id:u,path:g,data:e};return d?(s.callback=function(n){v.resolve({err:null,newValue:e,context:e.context}),DEBUG(2,"Key","add",c,"completed - promise")},s.error=function(e){ERROR(e,"add error - promise","Key","add"),v.reject(new Error(e))},o.set(s),v.promise):(s.callback=function(n){DEBUG(2,"Key","add",c,"completed - callback");var o=[null,e,_.merge(r,{addedKey:g})];t.apply(this,o)},s.error=function(e){ERROR(e,"add error - callback","Key","add");var n=[e,null,r];t.apply(this,n)},o.set(s),void 0)})}else{LOG(2,"Key","add","add successful - callback");var b=[null,s.get(),r];t.apply(this,b)}return i},O=[e,v,g,y,h];if(f&&_.has(y,"initializeOverride")&&(m=!0),!p&&!m){var j={operation:"add",callback:b,params:O,self:i};return d.push(j),LOG(2,"Key","add","not ready for add() operations",j),h?g.promise:i}return b.apply(this,O)},remove:function(e,n){var t=!1,i=!1,c=!1,f,p;hasValue(e)&&hasValue(n)?(t=!0,i=!0,f=e,p=n):hasValue(e)?isFunction(e)?(i=!0,p=e):(t=!0,c=!0,f=e):c=!0;var d=l;if(t&&_.has(f,"initializeOverride")&&(d=!0),d){var h={object_id:u,path:a};if(c){var y=Q.defer(),v=s.content.data;return INFO("add lastValue as option(default true right now)","Key","TODO - remove"),LOG("remove promise created","Key","remove"),h.callback=function(e){y.resolve({err:null,value:v,context:r}),LOG("remove promise resolved","Key","remove")},h.error=function(e){ERROR(e,"remove error - promise","Key","remove"),y.reject(new Error(e))},o.remove(h),y.promise}h.callback=function(e){LOG("remove successful - callback","Key","remove");var n=[null,value,_.merge(r,{lastValue:v})];p.apply(this,n)},h.error=function(e){ERROR(e,"remove error - callback","Key","remove");var n=[e,null,r];p.apply(this,n)}}else{LOG(u+"."+a+" - remove() deferred");var g={action:"remove",hasCallback:i,usePromise:c};if(c)return g.defer=Q.defer(),m.push(g),g.defer.promise;g.callback=p,m.push(g)}return this},set:function(e,n,t){var i=!1,c=!1,s=!1,f,p;hasValue(n)&&hasValue(t)?(i=!0,c=!0,f=n,p=t):hasValue(n)?isFunction(n)?(c=!0,p=n):(i=!0,s=!0,f=n):s=!0;var d=l;if(i&&_.has(f,"initializeOverride")&&(d=!0),d){var h={object_id:u,path:a,data:e};if(s){var y=Q.defer();return LOG("set promise created","Key","set"),h.callback=function(n){y.resolve({err:null,value:e,context:r}),LOG("set promise resolved","Key","set")},h.error=function(e){ERROR(e,"set error - promise","Key","set"),y.reject(new Error(e))},o.set(h),y.promise}h.callback=function(n){LOG("set success - callback executed","Key","set");var t=[null,e,r];p.apply(this,t)},h.error=function(e){ERROR(e,"set error - callback executed","Key","set");var n=[e,null,r];p.apply(this,n)}}else{LOG(u+"."+a+" - set() deferred");var v={action:"set",value:e,hasCallback:c,usePromise:s};if(s)return v.defer=Q.defer(),m.push(v),v.defer.promise;v.callback=p,m.push(v)}return this},merge:function(e,n,t){var i=!1,f=!1,p=!1,d,h;hasValue(n)&&hasValue(t)?(i=!0,f=!0,d=n,h=t):hasValue(n)?isFunction(n)?(f=!0,h=n):(i=!0,p=!0,d=n):p=!0;var y=l;if(i&&_.has(d,"initializeOverride")&&(y=!0),y){var v={object_id:u,path:a,data:e};if(p){var g=Q.defer();return DEBUG(2,"Key","merge",c,"promise created",e),v.callback=function(n){g.resolve({err:null,value:s.content.data,context:r}),DEBUG(2,"Key","merge",c,"promise resolved"),DEBUG(2,"Key","merge","value","",e),DEBUG(2,"Key","merge","syncData","",s.get())},v.error=function(e){ERROR(e,"merge error - promise","Key","merge"),g.reject(new Error(e))},o.merge(v),g.promise}v.callback=function(e){LOG("merge successful - callback","Key","merge");var n=[null,s.content.data,r];h.apply(this,n)},v.error=function(e){ERROR(e,"merge error - callback","Key","merge");var n=[e,null,r];h.apply(this,n)}}else{LOG(u+"."+c+" - merge() deferred");var b={action:"merge",value:e,hasCallback:f,usePromise:p};if(p)return b.defer=Q.defer(),m.push(b),b.defer.promise;b.callback=h,m.push(b)}return this},on:function(e,n,t){DEBUG(2,"Key","on",c,e);var r=!1,o=!1,i,u;if(isObject(n)?(r=!0,o=!0,i=n,u=t):(r=!1,o=!0,u=n),!isFunction(u))throw new Error("Listener is not a valid function");return"add"===e?v.add.push(u):"set"===e?v.set.push(u):"remove"===e&&v.remove.push(u),this},off:function(e,n,t){var r=!1,o=!1,i=!1,u=null,a=null;("undefined"!=typeof e||null!=e)&&(r=!0),"undefined"!=typeof n&&"undefined"!=typeof t?(o=!0,i=!0,u=n,a=t):"object"==typeof n?(o=!0,u=n):"function"==typeof n&&(i=!0,a=n),r||o||i||(v.join=null,v.leave=null)}})});
//# sourceMappingURL=./pubnub-goinstant.min.map